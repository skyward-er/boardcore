#!/usr/bin/python

# Skyward Build System Configuration File
#
# Copyright (c) 2015-2016 Skyward Experimental Rocketry
# Authors: Alain Carlucci
# 
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
# 
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
# THE SOFTWARE.

from optparse import OptionParser
import os, shutil, subprocess, sys

try:
    import ConfigParser as cp #python 2
except ImportError:
    import configparser as cp #python 3

def build_makefile(template, board, bname):
    rmap = { "BOARD_DEFINE": "export OPT_BOARD := %s\nexport BOARD_UUID := %s\n" % (
        board['id'], bname),
             "MAP_FILE": "export MAIN_MAP_FILE := bin/%s.map\n" % board['bin'],
             "SOURCE_FILES": "%s\n" % (" ".join(board['files'])),
             "CUSTOM_DEFINES": board['defines'],
             "BIN_NAME": board['bin'] 
    }
    
    for i in rmap:
        template = template.replace("{SBS_%s}" % i , rmap[i])
    return template

def banner():
    print("+---------------------------------------------------------------+")
    print("|   ____  _                                _                    |")
    print("|  / ___|| | ___   ___      ____ _ _ __ __| |                   |")
    print("|  \\___ \\| |/ / | | \\ \\ /\\ / / _` | '__/ _` |                   |")
    print("|   ___) |   <| |_| |\\ V  V / (_| | | | (_| |                   |")
    print("|  |____/|_|\\_\\\\__, | \\_/\\_/ \\__,_|_|  \\__,_|                   |")
    print("|   ____       |___/    _   ____            _                   |")
    print("|  | __ ) _   _(_) | __| | / ___| _   _ ___| |_ ___ _ __ ___    |")
    print("|  |  _ \\| | | | | |/ _` | \\___ \\| | | / __| __/ _ \\ '_ ` _ \\   |")
    print("|  | |_) | |_| | | | (_| |  ___) | |_| \\__ \\ ||  __/ | | | | |  |")
    print("|  |____/ \\__,_|_|_|\\__,_| |____/ \\__, |___/\\__\\___|_| |_| |_|  |")
    print("+----------------------------------|___/-------------------v2.0-+")

# Read command line options
parser = OptionParser()
parser.add_option("-c", "--clean", help="Run a 'make clean'", dest="clean", 
        action="store_true")
parser.add_option("-b", "--build", help="Build a specific entrypoint or test", dest="board")
parser.add_option("-l", "--list", help="List all possible configurations", dest="list",
    default=False, action='store_true')
parser.add_option("-t", "--all-test", help="Build all tests", dest="all_tests", default=False, action='store_true')
parser.add_option("-e", "--all-entry", help="Build all entrypoints", dest="all_entry", default=False, action='store_true')
parser.add_option("-g", "--gen-faults", help="Generate fault list header files and exit", dest="genhdr", default=False, action='store_true')
parser.add_option("-v", "--verbose", help="Print a verbose output", dest="log", 
        action="store_true")
parser.add_option("-j", "--jobs", 
        help="Specifies the number of jobs (commands) to run simultaneously.", 
        type="int", dest="JOBS", default=8)

(options, args) = parser.parse_args()

banner()

if options.genhdr == True:
    d1 = "data/fault_list.csv"
    d2 = "src/shared/diagnostic/FaultCounterData.h"
    os.system("/usr/bin/python scripts/gen_fault_headers.py %s %s" %(d1,d2))
    exit(0)

# Read SBS.conf file
conf = cp.RawConfigParser()
conf.read("sbs.conf")

mainmask = "src/entrypoints/%s.cpp"
testmask = "src/tests/%s.cpp"
srcfiles={}
boards={}
tests={}
entrypoints={}

for i in conf.sections():
    stype = conf.get(i, 'Type')
    if stype == 'srcfiles':
        srcfiles[i] = [x.strip() for x in conf.get(i, 'Files').split("\n")]
    elif stype == 'board':
        entrypoints[i] = {   'id': conf.get(i, 'BoardId'), 
                        'bin': conf.get(i, 'BinName'),
                        'defines': conf.get(i, 'Defines'),
                        'files': [mainmask % conf.get(i, 'Main').strip()] +
                         [x.strip() for x in conf.get(i, 'Include').split(' ')]
                    }     
    elif stype == 'test':
        tests[i] = {   'id': conf.get(i, 'BoardId'), 
                        'bin': conf.get(i, 'BinName'),
                        'defines': conf.get(i, 'Defines'),
                        'files': [testmask % conf.get(i, 'Main').strip()] +
                         [x.strip() for x in conf.get(i, 'Include').split(' ')]
                    }
    else:
        print('Type not implemented')

if (len(entrypoints) == 0 and len(tests) == 0 ):
    print('[SBS] Nothing found in sbs.conf . Terminating.')
    sys.exit(0)

# Substitute includes
for i in entrypoints:
    files = []
    for j in entrypoints[i]['files']:
        if j.startswith('%'):
            files += srcfiles[j[1:]]
        else:
            files += [j]
    entrypoints[i]['files'] = files

for i in tests:
    files = []
    for j in tests[i]['files']:
        if j.startswith('%'):
            files += srcfiles[j[1:]]
        else:
            files += [j]
    tests[i]['files'] = files

# Join lists
boards.update(entrypoints)
boards.update(tests)

# Load Makefile template
make_template = ""
with open('Makefile.template') as f:
    make_template = str(f.read())

if len(make_template) == 0:
    print('Makefile template empty or not found')
    sys.exit(-1)


# Do things
# List
if options.list == True:
    print('[SBS] List of available entrypoints:');
    for entrypoint in entrypoints:
        print(entrypoint)
    print('\n[SBS] List of available tests:');
    for test in tests:
        print(test)
    sys.exit(0)

# Clean before build
shutil.rmtree('build',ignore_errors=True, onerror=None)
os.mkdir('build')

# Specific build
if options.board != None:
    try:
        good = boards[options.board]
        boards = {options.board : good}
    except KeyError:
        print('[SBS] Board or test not found. Terminating.')
        sys.exit(2)
# Build entrypoints
elif options.all_entry == True:
    boards = entrypoints
# Build tests
elif options.all_tests == True:
    boards = tests

# Verbose
cleanparam = []
if options.log == True:
    procout = None
else:
    procout = open(os.devnull, 'w') 

# Build
action = ["Build","Building"]
if options.clean == True:
    cleanparam = ["clean"]
    action = ["Clean", "Cleaning"]

for i in boards:
    print('[SBS] %s %s' % (action[1],i))
    with open('build/%s' % i, 'w') as f:
        f.write(build_makefile(make_template, boards[i], i))
    try:
        if 'VERBOSE' in os.environ:
            subprocess.check_call(['make', '-j', str(options.JOBS), '-f', 'build/%s' % i] + cleanparam) # Don't eat stdiout
        else:
            subprocess.check_call(['make', '-j', str(options.JOBS), '-f', 'build/%s' % i] + cleanparam, stdout=procout) # Eat stdout
    except subprocess.CalledProcessError:
        print('[SBS] %s Failed. Terminating.' % action[0])
        sys.exit(-1)

    print('[SBS] %s OK' % action[0])

# Clean
if options.clean == True:
    shutil.rmtree('build',ignore_errors=True, onerror=None)
